<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>reveal.js â€“ The HTML Presentation Framework</title>

		<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
		<meta name="author" content="Hakim El Hattab">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/white.css" id="theme">
		<link rel="stylesheet" href="css/alitke.css">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">
			<img id="logo" src=""/>
			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h2>Sweep Away the Garbage</h2>
					<h4>for scalable, fault-tolerant shared VM storage</h4>
					<p>
						<small>
							Adam Litke - <a href=mailto:alitke@redhat.com>alitke@redhat.com</a><br>
							FOSDEM 2016 - 30 January 2016
						</small>
					</p>
				</section>

				<section>
					<h2>Local vm storage</h2>
					<img src="images/single-host-single-vm.svg" class="plain"/>
				</section>

				<section>
					<h2>Local vm storage</h2>
					<img src="images/single-host-many-vms.svg" class="plain"/>
				</section>

				<section>
					<h2>Multi-host local vm storage</h2>
					<img src="images/many-hosts-many-vms.svg" class="plain"/>
				</section>

				<section>
					<h2>Shared vm storage</h2>
					<img src="images/shared-storage.svg" class="plain"/>
				</section>

				<section>
					<h2>oVirt shared storage</h2>
					<img src="images/ovirt-storage-repo.svg" class="plain" />
				</section>

				<section>
					<h2>oVirt storage domain</h2>
					<img src="images/ovirt-storage-domain.svg" class="plain" />
				</section>

				<section>
					<h2>oVirt image</h2>
					<img src="images/ovirt-image.svg" class="plain" />
				</section>

				<section>
					<h2>oVirt volume</h2>
					<img src="images/ovirt-volume.svg" class="plain" />
				</section>

				<section>
					<section>
						<h2>Storage operation types</h2>
						<img src="images/storage-operations.svg" class="plain" />
					</section>

					<section>
						<h2>Datapath: volume access</h2>
						<img src="images/concurrent-volume-access.svg" class="plain" />
					</section>

					<section>
						<h2>Datapath: volume copy</h2>
						<img src="images/host-copy-volume.svg" class="plain" />
					</section>

					<section>
						<h2>Metadata: volume create</h2>
						<img src="images/create-volume.svg" class="plain" />
					</section>

					<section>
						<h2>Metadata: image delete</h2>
						<img src="images/delete-image.svg" class="plain" />
					</section>
				</section>

				<section>
					<section>
						<h2>Pitfall: conflicting operations</h2>
						<ul>
							<li>Concurrent operations that should be serialized</li>
							<li>Involve one or more hosts</li>
							<li>These are all bugs and may cause data corruption</li>
							<li>Can be prevented with correct locking</li>
						</ul>
					</section>

					<section>
						<h2>Same VM on multiple hosts</h2>
						<img src="images/same-vm-on-multiple-hosts.svg" class="plain"/>
					</section>

					<section>
						<h2>Conflicting metadata updates</h2>
						<img src="images/conflicting-storage-domain-metadata-updates.svg" class="plain" />
					</section>

					<section>
						<h2>Run VM while making a template</h2>
						<img src="images/run-vm-while-making-template.svg" class="plain" />
					</section>
				</section>

				<section>
					<section>
						<h2>Locking in oVirt</h2>
						<ul>
							<li>Storage level leases (via SANLock)
							<ul>
								<li>Protects storage against modification by other hosts</li>
								<li>Storage domain lease: protects metadata</li>
								<li>Volume lease: protects volume contents</li>
							</ul>
							</li>
							<li>Process level locking (local RWLock)
							<ul>
								<li>Protects storage against modification by other threads </li>
								<li>Storage domain lock</li>
								<li>Image lock</li>
								<li>Volume lock</li>
							</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>A word about sanlock</h2>
						<ul>
							<li>Host IDs
							<ul>
								<li>Every host has a unique ID</li>
								<li>Uniqueness is enforced by SANlock</li>
								<li>IDs must be periodically renewed</li>
								<li>Failure to renew will surrender all resource leases</li>
							</ul>
							</li>
							<li>Resource leases</li>
							<li><ul>
								<li>Represent an arbitrary resource (storage or otherwise)</li>
							</ul></li>
							<li>Misbehaving hosts will be fenced (rebooted)</li>
						</ul>
					</section>
				</section>

				<section>
					<section>
						<h2>Pitfall: interruptions</h2>
						<ul>
							<li>Some steps in a task are never completed</li>
							<li>Guaranteed to happen eventually</li>
							<li>Caused by
							<ul>
								<li>Power or network outage</li>
								<li>Hardware failure</li>
								<li>Software failure</li>
							</ul>
							</li>
							<li>Not bugs but must be mitigated to avoid corruption</li>
							<li>Graceful recovery
							<ul>
								<li>Task manager with rollback capability</li>
								<li>Transactions with garbage collection</li>
							</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Interrupted volume creation</h2>
						<img src="images/interrupted-volume-create.svg" class="plain" />
					</section>

					<section>
						<h2>Interrupted volume copy</h2>
						<img src="images/interrupted-volume-copy.svg" class="plain" />
					</section>
				</section>

				<section>
					<h2>Task manager with rollback</h2>
					<ul>
						<li>Original solution adopted by oVirt</li>
						<li>Requires tasks to be persistent on storage</li>
						<li>Rollbacks cannot always be executed</li>
						<li>Only one host can execute these tasks at a time</li>
					</ul>
				</section>

				<section>
					<h2>Transactions</h2>
					<ul>
						<li>Multi-step tasks accumulate garbage on storage</li>
						<li>Committed with an atomic storage update</li>
						<li>Tasks are only visible on the host while running</li>
						<li>Evidence of success or failure is on storage</li>
					</ul>
				</section>

				<section>
					<h2>Garbage collection</h2>
					<ul>
						<li>Lock-less scan to identify garbage candidates
						<ul>
							<li>eg. *.tmp files and directories</li>
						</ul>
						<li>Validate and clean garbage under lock
						<ul>
							<li>Acquired locks validate that this is garbage</li>
							<li>The garbage indicates what should be cleaned</li>
						</ul>
						<li>Scheduled to run periodically on one host</li>
						<li>May be run by a host directly in some cases</li>
					</ul>
				</section>

				<section>
					<section data-transition="none">
						<h2>Example: Create volume</h2>
						<img src="images/ex-create-00.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Acquire domain lease</h2>
						<img src="images/ex-create-01.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Acquire image lock</h2>
						<img src="images/ex-create-02.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Create volatile image directory</h2>
						<img src="images/ex-create-03.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Create volatile metadata file</h2>
						<img src="images/ex-create-04.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Create lease file</h2>
						<img src="images/ex-create-05.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Create volume data file</h2>
						<img src="images/ex-create-06.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Commit metadata file</h2>
						<img src="images/ex-create-07.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Commit image directory</h2>
						<img src="images/ex-create-08.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Release image lock</h2>
						<img src="images/ex-create-09.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Release domain lease</h2>
						<img src="images/ex-create-10.svg" class="plain" />
					</section>
				</section>

				<section>
					<section data-transition="none">
						<h2>Example: Remove volume</h2>
						<img src="images/ex-remove-00.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Acquire domain lease</h2>
						<img src="images/ex-remove-01.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Acquire image lock</h2>
						<img src="images/ex-remove-02.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Make image volatile</h2>
						<img src="images/ex-remove-03.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Invoke the garbage collector</h2>
						<img src="images/ex-remove-04.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Release image lock</h2>
						<img src="images/ex-remove-05.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Release domain lease</h2>
						<img src="images/ex-remove-06.svg" class="plain" />
					</section>
				</section>

				<section>
					<section data-transition="none">
						<h2>Example: Clone a volume</h2>
						<img src="images/ex-copy-00.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Create another volume</h2>
						<img src="images/ex-copy-01.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Acquire source image lock</h2>
						<img src="images/ex-copy-02.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Acquire target image lock</h2>
						<img src="images/ex-copy-03.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Acquire source volume lease</h2>
						<img src="images/ex-copy-04.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Acquire target volume lease</h2>
						<img src="images/ex-copy-05.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Mark target volume illegal</h2>
						<img src="images/ex-copy-06.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Copy data</h2>
						<img src="images/ex-copy-07.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Mark target volume legal</h2>
						<img src="images/ex-copy-08.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Release target volume lease</h2>
						<img src="images/ex-copy-09.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Release source volume lease</h2>
						<img src="images/ex-copy-10.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Release target image lock</h2>
						<img src="images/ex-copy-11.svg" class="plain" />
					</section>
					<section data-transition="none">
						<h2>Release source image lock</h2>
						<img src="images/ex-copy-12.svg" class="plain" />
					</section>
				</section>

				<section>
					<h2>Locking order</h2>
					<ul>
						<li>Strict rules needed to prevent deadlock</li>
						<li>Storage leases before local locks</li>
						<li>Big containers before smaller containers
						<ul>
							<li>Storage Domain &#10145; Image &#10145; Volume</li>
						</ul>
						</li>
						<li>Source volume before destination volume</li>
						<li>Release the newest locks first</li>
					</ul>
				</section>

				<section>
					<h2>Resources</h2>
					<ul>
						<li><a href="http://www.ovirt.org/">http://www.ovirt.org</a></li>
						<li><a href="https://fedorahosted.org/sanlock/">https://fedorahosted.org/sanlock/</a></li>
						<li><a href="irc://irc.oftc.net/ovirt">irc://irc.oftc.net/ovirt</a></li>
						<li><a href="http://lists.ovirt.org/mailman/listinfo/devel">http://lists.ovirt.org/mailman/listinfo/devel</a></li>
						<li><a href="http://lists.ovirt.org/mailman/listinfo/users">http://lists.ovirt.org/mailman/listinfo/users</a></li>
					</ul>
				</section>

				<section>
					<h2>Questions?</h2>
				</section>

				<section>
					<h2>Test overlay</h2>
					<img src="images/ovirt-image.svg" class="plain" />
					<img src="images/ovirt-volume.svg" class="plain fragment"
							style="position: absolute; top:100px; left:200px;"/>
				</section>

				<section>
					<h2>Test tables</h2>
					<table>
						<tr>
							<td><img src="images/ovirt-volume.svg" class="plain"/></td>
							<td style="vertical-align: middle;">
								<ul>
									<li>Item A</li>
									<li>Item B</li>
									<li>Item C</li>
								</ul>
							</td>
						</tr>
					</table>
				</section>

			</div>

			<p id="watermark">
				Sweeping Away the Garbage - FOSDEM 30.01.2016
			</p>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'convex', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
